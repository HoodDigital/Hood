$.hood||($.hood={}),$.hood.Designer={Drake:null,Init:function(){$("body").on("click",".save-content",$.hood.Designer.Save),$("body").on("click",".hood-add-block",$.hood.Designer.Blocks.Add),$("body").on("click",".choose-content-block",$.hood.Designer.Blocks.ChooseBlock),$("body").on("click",".insert-content-block",$.hood.Designer.Blocks.InsertBlock),$("body").on("click",".hood-delete-block",$.hood.Designer.Blocks.Delete),$("body").on("click","figure.img",$.hood.Designer.Images.Change),$("body").on("click","a:not(.admin)",function(e){$.hood.Alerts.Warning("Links do not work in the preview window."),e.preventDefault()}),$("body").on("click",".toggle-editors",function(e){$("body").hasClass("hood-editors-active")?$.hood.Designer.ContentMode():$.hood.Designer.LayoutMode()}),$.hood.Helpers.InIframe()?($("#designer-bar .back-to-edit").hide(),$(".hood-admin-editor").hide()):$("#designer-bar .open-full").hide(),this.InitContent(),this.InitDragula(),this.InitEditors()},Loader:{Show:function(){$("div#hood-designer-loader").fadeIn()},Hide:function(){$("div#hood-designer-loader").fadeOut()}},ContentMode:function(){$(".toggle-editors").removeClass("btn-default").addClass("btn-info").html('<i class="fa fa-arrows-alt m-r-sm"></i>Edit Mode'),$("body").removeClass("hood-editors-active")},LayoutMode:function(){$(".toggle-editors").removeClass("btn-info").addClass("btn-default").html('<i class="fa fa-desktop m-r-sm"></i>Preview Mode'),$("body").addClass("hood-editors-active")},InitContent:function(){$("#editable-content").find(".hood-block").length?$("#editable-content").find(".hood-block").append($.hood.Designer.Blocks.BlockControls):(content=$("#editable-content").html(),editor=$('<div class="hood-block-general tinymce-free"></div>').append(content),block=$('<div class="hood-block"></div>'),block.append(editor),block.append($.hood.Designer.Blocks.BlockControls),$("#editable-content").empty().append(block)),setTimeout(function(){$.hood.Designer.Loader.Hide()},1500)},InitDragula:function(){this.Drake=dragula({revertOnSpill:!0,moves:function(e,o,t){return t.classList.contains("hood-drag-handle")},isContainer:function(e){return e.classList.contains("editable-content")}})},InitEditors:function(){tinymce.init({selector:".tinymce-free",plugins:["advlist autolink lists link image charmap print preview anchor media table","searchreplace visualblocks code fullscreen","insertdatetime media contextmenu paste code"],toolbar:"styleselect | bold italic | alignleft aligncenter alignright | bullist numlist outdent indent | undo redo | link image media hoodimage | code",selection_toolbar:"styleselect | bold italic | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | undo redo | link image",insert_toolbar:"quickimage quicktable",height:500,menubar:!1,link_class_list:$.hood.LinkClasses,setup:$.hood.Uploader.Load.Insert,inline:!0,image_advtab:!0,paste_data_images:!0,images_upload_handler:function(e,o,t){var n,i;n=new XMLHttpRequest,n.withCredentials=!1,n.open("POST","/admin/media/upload/single?directory="+$("#designer-bar").data("upload")),n.onload=function(){var e;return 200!=n.status?void t("HTTP Error: "+n.status):(e=JSON.parse(n.responseText),e&&"string"==typeof e.location?void o(e.location):void t("Invalid JSON: "+n.responseText))},i=new FormData,i.append("file",e.blob(),e.filename()),n.send(i)},content_css:[]}),tinymce.init({selector:".tinymce-basic",plugins:["advlist autolink lists link image charmap print preview anchor media table","searchreplace visualblocks code fullscreen","insertdatetime media contextmenu paste code"],toolbar:"styleselect | bold italic | alignleft aligncenter alignright",selection_toolbar:"styleselect | bold italic | alignleft aligncenter alignright",menubar:!1,link_class_list:$.hood.LinkClasses,setup:$.hood.Uploader.Load.Insert,inline:!0,content_css:[]}),tinymce.init({selector:".tinymce-text",toolbar:"bold italic underline | quicklink | undo redo",menubar:!1,inline:!0}),tinymce.init({selector:".tinymce-buttons",plugins:"link contextmenu",toolbar:"link | undo redo",menubar:!1,inline:!0})},KillDragula:function(){this.Drake.destroy()},KillEditors:function(){tinymce.remove(".tinymce-free"),tinymce.remove(".tinymce-text"),tinymce.remove(".tinymce-buttons")},Blocks:{BlockControls:'<div class="hood-drag-handle"></div><div class="hood-delete-block"><i class="fa fa-trash-o"></i></div>',Add:function(e){$.hood.Designer.Loader.Show(),$.hood.Modals.Open("/admin/content/choose",null,".hood-attach",$.proxy(function(){$.hood.Designer.Blocks.BlockList(),$.hood.Designer.Loader.Hide()},this))},ChooseBlock:function(e){ds=$("#content-block-list").data("hoodDataList").DataSource,itm=ds.getByUid($(this).data("uid")),template=kendo.template($("#content-block-insert-template").html()),preview=template(itm),$("#insert-block-details").html(preview)},InsertBlock:function(e){$.hood.Designer.Loader.Show(),$.hood.Designer.KillDragula(),$.hood.Designer.KillEditors(),params=$("#content-block-variables").serializeArray(),params.push({name:"url",value:$(this).data("url")}),$.get("/admin/content/block",params,function(e){html=$("<div></div>").append(e).find(".hood-block").append($.hood.Designer.Blocks.BlockControls).end().html(),$("#editable-content").append(html)}).done(function(){$.hood.Alerts.Success("Inserted.")}).fail(function(){$.hood.Alerts.Error("There was a problem adding the block.")}).always(function(){$.hood.Designer.InitDragula(),$.hood.Designer.InitEditors(),$.hood.Designer.Loader.Hide()})},BlockList:function(){$("#content-block-list").hoodDataList({url:"/admin/content/blocks",params:function(){return{}},pageSize:12,pagers:".content-block-pager",template:"#content-block-template",dataBound:function(){},refreshOnChange:".content-block-change",refreshOnClick:".content-block-click",serverAction:"GET"})},Refresh:function(){$("#content-block-list").doesExist()&&$("#content-block-list").data("hoodDataList").Refresh()},Delete:function(e){$(this).parent().remove()}},Images:{Change:function(){}},Save:function(){$.hood.Designer.Loader.Show(),$("body").removeClass("hood-editors-active"),$.hood.Designer.KillDragula(),$.hood.Designer.KillEditors();var e=$("#editable-content").html(),o=$("<div></div>");o.append(e),$(o).find(".hood-drag-handle").remove(),$(o).find(".hood-delete-block").remove(),o=$(o).find(".tinymce-free").removeClass("mce-content-body").removeAttr("style").removeAttr("contenteditable").removeAttr("spellcheck").removeAttr("id").end().html(),params={Id:$("#editable-content").data("id"),Body:o},$.post("/admin/content/designer/save/",params,function(e){e.Succeeded?$.hood.Alerts.Success("Saved"):$.hood.Alerts.Error(e.ErrorString)}).done(function(){}).fail(function(){}).always(function(){$.hood.Designer.InitDragula(),$.hood.Designer.InitEditors(),$.hood.Designer.Loader.Hide()})}},$(window).on("load",function(){$.hood.Designer.Init()});