@model SubscriptionModel
@inject ISiteConfiguration _site
@{
    BillingSettings settings = _site.GetBillingSettings();
    ViewBag.Title = "Add a new card to your account";
}
<div class="row">
    <div class="col-sm-6 col-sm-offset-3">
        <div class="well">
            <form asp-action="AddCard" method="POST" id="payment-form">
                <h3>Add your new card... </h3>
                <div class="payment-errors"></div>
                <div class="collapse in" id="new-card-form">
                    <div class="row">
                        <div class="col-xs-6">
                            <div class="form-group">
                                <label class="control-label">Card Number:</label>
                                <div class="input-group">
                                    <input size="20" data-stripe="number" class="form-control" placeholder="Card number..." />
                                </div>
                            </div>
                        </div>
                        <div class="col-xs-6">
                            <div class="form-group">
                                <label class="control-label">Billing Postcode</label>
                                <div class="input-group">
                                    <input data-stripe="address_zip" class="form-control" placeholder="Zip or Postal Code..." />
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-xs-6">
                            <div class="form-group">
                                <label class="control-label">Expiry Date:</label>
                                <div class="input-group">
                                    <select data-stripe="exp_month">
                                        <option value="" selected>MM</option>
                                        @for (int i = 1; i < 13; i++)
                                        {
                                            <option value="@i.ToString("D2")">@i.ToString("D2")</option>
                                        }
                                    </select>
                                    <span> / </span>
                                    <select data-stripe="exp_year">
                                        <option value="" selected>YY</option>
                                        @for (int i = DateTime.Now.Year; i < DateTime.Now.Year + 15; i++)
                                        {
                                            <option value="@i">@i</option>
                                        }
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="col-xs-6">
                            <div class="form-group">
                                <label class="control-label">CVC</label>
                                <div class="input-group">
                                    <input data-stripe="cvc" class="form-control" placeholder="CVC Security Number..." />
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <input type="submit" class="submit btn btn-primary" value="Save Card" />
            </form>
        </div>
    </div>
</div>
@section scripts {
    <script type="text/javascript" src="https://js.stripe.com/v2/"></script>
    <script type="text/javascript">
        Stripe.setPublishableKey('@(settings.EnableStripeTestMode ? settings.StripeTestPublicKey : settings.StripeLivePublicKey)');
        $(function () {
            var $form = $('#payment-form');
            $form.submit(function (event) {
                // Disable the submit button to prevent repeated clicks:
                $form.find('.submit').prop('disabled', true);

                // Request a token from Stripe:
                Stripe.card.createToken($form, stripeResponseHandler);

                // Prevent the form from being submitted:
                return false;
            });
        });

        function stripeResponseHandler(status, response) {
            // Grab the form:
            var $form = $('#payment-form');

            if (response.error) { // Problem!

                // Show the errors on the form:
                $form.find('.payment-errors').html(response.error.message).addClass("validation-summary-errors");
                $form.find('.submit').prop('disabled', false); // Re-enable submission

            } else { // Token was created!

                // Get the token ID:
                var token = response.id;
                $form.find('.payment-errors').html('').removeClass("validation-summary-errors");
                // Insert the token ID into the form so it gets submitted to the server:
                $form.append($('<input type="hidden" name="StripeToken" id="StripeToken">').val(token));

                // Submit the form:
                $form.get(0).submit();
            }
        };
    </script>
}