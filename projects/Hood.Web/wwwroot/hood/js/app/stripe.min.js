"use strict";$.hood||($.hood={}),$.hood.Stripe={Init:function(){$("body").on("click",".payment-method-setdefault",$.hood.Stripe.PaymentMethods.SetDefault),$("body").on("click",".payment-method-delete",$.hood.Stripe.PaymentMethods.Delete),$("#card-add-form").doesExist()&&$.hood.Stripe.PaymentMethods.Add(),$("#buy-plan-form").doesExist()&&$.hood.Stripe.Subscriptions.Buy()},Lists:{PaymentMethods:{Loaded:function(e){$.hood.Loader(!1)},Reload:function(e){$("#payment-method-list").doesExist()&&$.hood.Inline.Reload($("#payment-method-list"),e)}}},PaymentMethods:{Stripe:null,CardElement:null,Add:function(){$.hood.Stripe.PaymentMethods.Stripe=Stripe($("#card-add-form").data("stripe"));var e=$.hood.Stripe.PaymentMethods.Stripe.elements();$.hood.Stripe.PaymentMethods.CardElement=e.create("card"),$.hood.Stripe.PaymentMethods.CardElement.mount("#card-add-element"),$("#card-add-form").validate({rules:{CardholderName:"required"}}),$("body").on("click","#card-add-submit",$.hood.Stripe.PaymentMethods.SubmitCardForm)},SubmitCardForm:function(e){return e.preventDefault(),$("#card-add-consent").is(":checked")?void($("#card-add-form").valid()&&!$("#card-add-submit").hasClass("processing")&&($.hood.Stripe.PaymentMethods.ToggleButton(!0),$.hood.Stripe.PaymentMethods.Stripe.handleCardSetup($("#card-add-submit").data("secret"),$.hood.Stripe.PaymentMethods.CardElement,{payment_method_data:{billing_details:{name:$("#card-add-cardholdername").val()}}}).then(function(e){e.error?($.hood.Stripe.PaymentMethods.ShowError(response.error),$.hood.Stripe.PaymentMethods.ToggleButton(!1)):($.hood.Stripe.PaymentMethods.ShowSuccess("Confirming your card..."),$.hood.Stripe.PaymentMethods.ConfirmIntent(e))}))):($.hood.Stripe.PaymentMethods.ShowError("You cannot add a card without agreeing to the customer agreement."),void $.hood.Stripe.PaymentMethods.ToggleButton(!1))},HandleServerResponse:function(e){e.error?($.hood.Stripe.PaymentMethods.ShowError(e.error),$.hood.Stripe.PaymentMethods.ToggleButton(!1)):e.requires_action?($.hood.Stripe.PaymentMethods.ShowError("We require confirmation from your card issuer to continue..."),$.hood.Stripe.PaymentMethods.Stripe.handleCardAction(e.payment_intent_client_secret).then(function(e){e.error?($.hood.Stripe.PaymentMethods.ShowError(e.error),$.hood.Stripe.PaymentMethods.ToggleButton(!1)):($.hood.Stripe.PaymentMethods.ShowSuccess("Confirming your card..."),$.hood.Stripe.PaymentMethods.ConfirmIntent(e))})):($.hood.Stripe.PaymentMethods.ShowSuccess("Card added successfully, please wait..."),$.hood.Stripe.PaymentMethods.ToggleButton(!1),$.hood.Stripe.Lists.PaymentMethods.Reload(),$.hood.Inline.CloseModal())},ConfirmIntent:function(e){fetch($("#card-add-submit").data("url"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({Id:e.setupIntent.id})}).then(function(e){return e.json().then($.hood.Stripe.PaymentMethods.HandleServerResponse)})},ToggleButton:function(e){e?($("#card-add-submit").addClass("processing"),$("#card-add-submit").html('<i class="fa fa-spin fa-sync-alt"></i>&nbsp;Processing...')):($("#card-add-submit").removeClass("processing"),$("#card-add-submit").html("Add card to wallet"))},SetDefault:function(e){e.preventDefault(),$tag=$(this),setDefaultCardCallback=function(e){e&&$.post($tag.attr("href"),function(e){$.hood.Helpers.ProcessResponse(e),$.hood.Stripe.Lists.PaymentMethods.Reload()})},$.hood.Alerts.Confirm("The card will be used for all transactions from this point onwards.","Are you sure?",setDefaultCardCallback,"warning",'<span class="text-info"><i class="fa fa-exclamation-triangle"></i> <strong>You can change this at any time.</strong></span>')},Delete:function(e){e.preventDefault(),$tag=$(this),deleteCardCallback=function(e){e&&$.post($tag.attr("href"),function(e){$.hood.Helpers.ProcessResponse(e),$.hood.Stripe.Lists.PaymentMethods.Reload(),e.Success&&$tag&&$tag.data("redirect")&&($.hood.Alerts.Success("<strong>Card deleted, redirecting...</strong><br />Just taking you back to the list."),setTimeout(function(){window.location=$tag.data("redirect")},1500))})},$.hood.Alerts.Confirm("The card will be permanently removed.","Are you sure?",deleteCardCallback,"error",'<span class="text-danger"><i class="fa fa-exclamation-triangle"></i> <strong>This process CANNOT be undone!</strong></span>')},ShowError:function(e){$("#card-add-success").html(""),e.message?$("#card-add-errors").html(e.message):$("#card-add-errors").html(e)},ShowSuccess:function(e){$("#card-add-errors").html(""),$("#card-add-success").html(e)}},Subscriptions:{Stripe:null,CardElement:null,Buy:function(){$("body").on("change",".buy-plan-method",$.hood.Stripe.Subscriptions.ToggleNewCardForm),$.hood.Stripe.Subscriptions.Stripe=Stripe($("#buy-plan-form").data("stripe"));var e=$.hood.Stripe.Subscriptions.Stripe.elements();$.hood.Stripe.Subscriptions.CardElement=e.create("card"),$.hood.Stripe.Subscriptions.CardElement.mount("#buy-plan-element"),$.hood.Stripe.Subscriptions.CardElement.addEventListener("change",function(e){e.error?$.hood.Stripe.Subscriptions.ShowError(result.error):$.hood.Stripe.Subscriptions.ShowError("")}),$("#buy-plan-form").validate({rules:{CardholderName:"required"}}),$("body").on("click","#buy-plan-submit",$.hood.Stripe.Subscriptions.CompletePurchase)},CompletePurchase:function(e){var t=$("input[name='buy-plan-method']:checked").val();return t?$("#buy-plan-consent").is(":checked")?"new-card"===t?$.hood.Stripe.Subscriptions.BuyWithNewCard(e):$.hood.Stripe.Subscriptions.BuyWithExisting(e):($.hood.Stripe.Subscriptions.ShowError("You cannot purchase a subscription without agreeing to the customer agreement."),void $.hood.Stripe.Subscriptions.ToggleButton(!1)):($.hood.Stripe.Subscriptions.ShowError("You have to select a payment method to continue with your purchase."),void $.hood.Stripe.Subscriptions.ToggleButton(!1))},ToggleNewCardForm:function(e){var t=$("input[name='buy-plan-method']:checked").val();"new-card"===t?$("#buy-plan-add-card-form").slideDown():$("#buy-plan-add-card-form").slideUp(),$.hood.Stripe.Subscriptions.ShowError("")},BuyWithExisting:function(e){e.preventDefault(),$("#buy-plan-submit").hasClass("processing")||fetch($("#buy-plan-submit").data("url"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({PlanId:$("#buy-plan-id").val(),PaymentMethodId:$("input[name='buy-plan-method']:checked").val()})}).then(function(e){return e.json()}).then($.hood.Stripe.Subscriptions.HandleServerResponse)},BuyWithNewCard:function(e){e.preventDefault(),$("#buy-plan-form").valid()&&!$("#buy-plan-submit").hasClass("processing")&&($.hood.Stripe.Subscriptions.ToggleButton(!0),$.hood.Stripe.Subscriptions.Stripe.createToken($.hood.Stripe.Subscriptions.CardElement).then(function(e){e.error?($.hood.Stripe.Subscriptions.ShowError(e.error),$.hood.Stripe.Subscriptions.ToggleButton(!1)):($.hood.Stripe.PaymentMethods.ShowSuccess("Confirming your card..."),fetch($("#buy-plan-submit").data("url"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({PlanId:$("#buy-plan-id").val(),Token:e.token.id})}).then(function(e){return e.json()}).then($.hood.Stripe.Subscriptions.HandleServerResponse))}))},HandleServerResponse:function(e){e.error?($.hood.Stripe.Subscriptions.ShowError(e.error),$.hood.Stripe.Subscriptions.ToggleButton(!1)):e.requires_action?$.hood.Stripe.Subscriptions.Stripe.handleCardPayment(e.payment_intent_client_secret).then(function(e){e.error?($.hood.Stripe.Subscriptions.ShowError(e.error),$.hood.Stripe.Subscriptions.ToggleButton(!1)):($.hood.Stripe.PaymentMethods.ShowSuccess("Confirming your card..."),$.hood.Stripe.Subscriptions.ConfirmIntent(e))}):($.hood.Stripe.Subscriptions.ShowSuccess("Subscription created successfully, please wait..."),$.hood.Stripe.Subscriptions.ToggleButton(!1),e.url&&(window.location=e.url))},ConfirmIntent:function(e){fetch($("#buy-plan-submit").data("url"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({PlanId:$("#buy-plan-id").val(),IntentId:e.paymentIntent.id})}).then(function(e){return e.json().then($.hood.Stripe.Subscriptions.HandleServerResponse)})},ToggleButton:function(e){e?($("#buy-plan-submit").addClass("processing"),$("#buy-plan-submit").html('<i class="fa fa-spin fa-sync-alt"></i>&nbsp;Processing...')):($("#buy-plan-submit").removeClass("processing"),$("#buy-plan-submit").html("Confirm &amp; Pay"))},ShowError:function(e){$("#buy-plan-success").html(""),e.message?$("#buy-plan-errors").html(e.message):$("#buy-plan-errors").html(e)},ShowSuccess:function(e){$("#buy-plan-errors").html(""),$("#buy-plan-success").html(e)}}},$.hood.Stripe.Init();