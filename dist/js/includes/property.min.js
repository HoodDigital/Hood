$.hood||($.hood={}),$.hood.Property={Init:function(){$("body").on("click",".delete-property",this.Delete),$("body").on("click",".archive-property",this.Archive),$("body").on("click",".publish-property",this.Publish),$("body").on("click",".create-property",this.Create.Init),$("#manage-property-list").doesExist()&&this.Manage.Init(),$("#edit-property").doesExist()&&this.Edit.Init()},Manage:{Loaded:!1,Init:function(){vars=$.getUrlVars(),"undefined"!=typeof vars.search&&""!==vars.search&&$("#manage-property-search").val($.decodeUrl(vars.search)),"undefined"!=typeof vars.sort&&""!==vars.sort&&$("#manage-property-sort").val($.decodeUrl(vars.sort)),"undefined"!=typeof vars.type&&""!==vars.type&&$("#manage-property-type").val($.decodeUrl(vars.type)),"undefined"!=typeof vars.planning&&""!==vars.planning&&$("#manage-property-planning").val($.decodeUrl(vars.planning)),"false"===vars.all?$("#manage-property-showall").prop("checked",!1):$("#manage-property-showall").prop("checked",!0),$("#manage-property-list").hoodDataList({url:"/admin/property/get",params:this.Params,pageSize:12,pagers:".manage-property-pager",template:"#manage-property-template",dataBound:function(){if($.hood.Property.Manage.Loaded||(page=$.getUrlVars().page,isNaN(page)&&(page=1),this.dataSource.page(page),$.hood.Property.Manage.Loaded=!0),history.pushState){var e=location.pathname+"?"+$.param($.hood.Property.Manage.Params())+"&page="+this.dataSource.page();window.history.pushState({path:e},"",e)}},refreshOnChange:".manage-property-change",refreshOnClick:".manage-property-click",serverAction:"GET"})},Params:function(){return{search:$("#manage-property-search").val(),sort:$("#manage-property-sort").val(),type:$("#manage-property-type").val(),planning:$("#manage-property-planning").val(),all:$("#manage-property-showall").is(":checked")}},Filter:function(){return{search:$("#manage-property-search").val(),sort:$("#manage-property-sort").val()}},Refresh:function(){$("#manage-property-list").doesExist()&&$("#manage-property-list").data("hoodDataList").Refresh(),$.hood.Blades.Reload()}},Delete:function(e){var r=$(this);swal({title:"Are you sure?",text:"The property will be permanently removed.",type:"warning",confirmButtonColor:"#DD6B55",confirmButtonText:"Yes, go ahead.",cancelButtonText:"No, cancel!",showCancelButton:!0,closeOnConfirm:!1,showLoaderOnConfirm:!0,closeOnCancel:!1},function(e){e?$.post("/admin/property/delete",{id:r.data("id")},function(e){e.Success?($("#manage-property-list").doesExist()||(window.location="/admin/property/manage"),$.hood.Property.Manage.Refresh(),$.hood.Blades.Close(),swal({title:"Deleted!",text:"The property has now been removed from the website.",timer:1300,type:"success"})):swal({title:"Error!",text:"There was a problem deleting the property: "+e.Errors,timer:1300,type:"error"})}):swal("Cancelled","It's all good in the hood!","error")})},Publish:function(e){var r=$(this);swal({title:"Are you sure?",text:"The property will be visible on the website.",type:"warning",confirmButtonColor:"#DD6B55",confirmButtonText:"Yes, go ahead.",cancelButtonText:"No, cancel!",showCancelButton:!0,closeOnConfirm:!1,showLoaderOnConfirm:!0,closeOnCancel:!1},function(e){e?$.post("/admin/property/publish",{id:r.data("id")},function(e){e.Success?($("#manage-property-list").doesExist()||(window.location="/admin/property/manage"),$.hood.Property.Manage.Refresh(),$.hood.Blades.Close(),swal({title:"Published!",text:"The property has now been published.",timer:1300,type:"success"})):swal({title:"Error!",text:"There was a problem publishing the property: "+e.Errors,timer:1300,type:"error"})}):swal("Cancelled","It's all good in the hood!","error")})},Archive:function(e){var r=$(this);swal({title:"Are you sure?",text:"The property will be hidden from the website.",type:"warning",confirmButtonColor:"#DD6B55",confirmButtonText:"Yes, go ahead.",cancelButtonText:"No, cancel!",showCancelButton:!0,closeOnConfirm:!1,showLoaderOnConfirm:!0,closeOnCancel:!1},function(e){e?$.post("/admin/property/archive",{id:r.data("id")},function(e){e.Success?($("#manage-property-list").doesExist()||(window.location="/admin/property/manage"),$.hood.Property.Manage.Refresh(),$.hood.Blades.Close(),swal({title:"Archived!",text:"The property has now been archived.",timer:1300,type:"success"})):swal({title:"Error!",text:"There was a problem archiving the property: "+e.Errors,timer:1300,type:"error"})}):swal("Cancelled","It's all good in the hood!","error")})},Create:{Init:function(e){e.preventDefault(),$.hood.Blades.OpenWithLoader("button.create-property","/admin/property/create/",$.hood.Property.Create.SetupCreateForm)},SetupCreateForm:function(){$("#create-property-form").find(".datepicker").datepicker({todayBtn:"linked",keyboardNavigation:!1,forceParse:!1,calendarWeeks:!0,autoclose:!0,orientation:"bottom",format:"dd/mm/yyyy"}),$("#create-property-form").hoodValidator({validationRules:{cpTitle:{required:!0},cpAddress1:{required:!0},cpCity:{required:!0},cpCounty:{required:!0},cpCountry:{required:!0},cpPostcode:{required:!0},cpPublishDate:{required:!0,ukdate:!0}},submitButtonTag:$("#create-property-submit"),submitUrl:"/admin/property/add",submitFunction:function(e){e.Success?($("#manage-property-list").data("hoodDataList").Refresh(),swal("Created!","The property has now been created!","success")):swal("Error","There was a problem creating the property:\n\n"+e.Errors,"error")}}),$.hood.Handlers.Addresses.InitAutocomplete()}},Edit:{Init:function(){this.LoadEditors("#edit-property"),$.hood.Property.Upload.InitImageUploader(),$.hood.Property.Upload.InitFloorplanUploader(),$("body").on("click",".add-floor",this.AddFloor),$("body").on("click",".delete-floor",this.DeleteFloor),$("body").on("change",".recalc-floor",this.RecalcFloor)},AddFloor:function(){var e=$("#Floor-Number").val(),r=$.hood.Property.Edit.GetFloorsList();return exists=!1,$.each(r,function(r,o){o.Number==e&&(exists=!0)}),exists?void $.hood.Alerts.Error("Cannot insert two floors with the same number."):(newFloor={Name:$("#Floor-Name").val(),SquareFeet:$("#Floor-SquareFeet").val(),SquareMetres:$("#Floor-SquareMetres").val(),Number:$("#Floor-Number").val()},r.push(newFloor),$.hood.Property.Edit.ReRenderFloors(r),void $("#Floors").val(JSON.stringify(r)))},DeleteFloor:function(){var e=$.hood.Property.Edit.GetFloorsList(),r=$(this).data("number");e=$.grep(e,function(e){return e.Number!=r}),$.hood.Property.Edit.ReRenderFloors(e),$("#Floors").val(JSON.stringify(e))},RecalcFloor:function(e){"Floor-SquareMetres"==this.id?$("#Floor-SquareFeet").val(10.7639*Number($(this).val())):$("#Floor-SquareMetres").val(Number($(this).val())/10.7639)},GetFloorsList:function(){if(floorsInput=$("#Floors").val(),null!=floorsInput&&""!=floorsInput){var e=JSON.parse(floorsInput);for(var r in e)if(e[r].hasOwnProperty("Name"))return e}return new Array},ReRenderFloors:function(e){for(e.sort(function(e,r){var o=Number(e.Number),t=Number(r.Number);return o<t?-1:o>t?1:0}),newList=$(".floor-list").empty(),i=0;i<e.length;i++)newList.append("<div class='row m-b-xs'><div class='col-xs-4'><strong>"+e[i].Name+"</strong> "+e[i].Number+"</div><div class='col-xs-8'>"+$.numberWithCommas(Math.round(e[i].SquareMetres))+" m<sup>2</sup> ["+$.numberWithCommas(Math.round(e[i].SquareFeet))+" sq. ft.] <a class='delete-floor btn btn-xs bg-color-red txt-color-white' data-number='"+e[i].Number+"'><i class='fa fa-trash-o'></i></a></div></div>")},Blade:function(){this.LoadEditors("#property-blade"),$("#property-blade select").each($.hood.Handlers.SelectSetup),$("#property-blade-form").hoodValidator({validationRules:{Title:{required:!0},Excerpt:{required:!0}},submitButtonTag:$("#save-blade"),submitUrl:"/admin/property/save/"+$("#property-blade-form").data("id"),submitFunction:function(e){e.Succeeded?($("#manage-property-list").data("hoodDataList").Refresh(),$.hood.Alerts.Success("Updated.")):$.hood.Alerts.Error("There was an error saving.")}})},LoadEditors:function(e){$(e).find(".datepicker").datepicker({todayBtn:"linked",keyboardNavigation:!1,forceParse:!0,calendarWeeks:!0,autoclose:!0,orientation:"bottom",format:"dd/mm/yyyy"})}},Upload:{InitImageUploader:function(){Dropzone.autoDiscover=!1;var e=new Dropzone("#property-gallery-upload",{url:"/admin/property/upload/gallery?id="+$("#property-gallery-upload").data("id"),thumbnailWidth:80,thumbnailHeight:80,parallelUploads:5,previewTemplate:!1,paramName:"files",autoProcessQueue:!0,previewsContainer:!1,clickable:"#property-gallery-add",dictDefaultMessage:'<span><i class="fa fa-cloud-upload fa-4x"></i><br />Drag and drop files here, or simply click me!</div>',dictResponseError:"Error while uploading file!"});e.on("success",function(e,r){0==r.Success?$.hood.Alerts.Error("Uploads failed: "+r.Error):$.hood.Alerts.Success("Uploads completed successfully.")}),e.on("totaluploadprogress",function(e){document.querySelector("#gallery-total-progress .progress-bar").style.width=e+"%"}),e.on("sending",function(e){document.querySelector("#gallery-total-progress").style.opacity="1"}),e.on("complete",function(e){$.hood.Inline.Refresh(".gallery")}),e.on("queuecomplete",function(e){document.querySelector("#gallery-total-progress").style.opacity="0",$.hood.Inline.Refresh(".gallery")})},InitFloorplanUploader:function(){Dropzone.autoDiscover=!1;var e=new Dropzone("#property-floorplans-upload",{url:"/admin/property/upload/floorplan?id="+$("#property-floorplans-upload").data("id"),thumbnailWidth:80,thumbnailHeight:80,parallelUploads:5,previewTemplate:!1,paramName:"files",autoProcessQueue:!0,previewsContainer:!1,clickable:"#property-floorplans-add",dictDefaultMessage:'<span><i class="fa fa-cloud-upload fa-4x"></i><br />Drag and drop files here, or simply click me!</div>',dictResponseError:"Error while uploading file!"});e.on("success",function(e,r){0==r.Success?$.hood.Alerts.Error("Uploads failed: "+r.Error):$.hood.Alerts.Success("Uploads completed successfully.")}),e.on("totaluploadprogress",function(e){document.querySelector("#floorplans-total-progress .progress-bar").style.width=e+"%"}),e.on("sending",function(e){document.querySelector("#floorplans-total-progress").style.opacity="1"}),e.on("complete",function(e){$.hood.Inline.Refresh(".gallery")}),e.on("queuecomplete",function(e){document.querySelector("#floorplans-total-progress").style.opacity="0",$.hood.Inline.Refresh(".floorplans"),$.hood.Alerts.Success("Uploads completed successfully.")})}}},$.hood.Property.Init();